{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Formulario</title>
    <link rel="stylesheet" href="{% static 'styles/formulario.css' %}">
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
</head>
<body>

<header>
    <h1>Formulario de Registro</h1>
    <p>Completa tus datos a continuaci√≥n</p>
</header>

<main>
    <div class="page-container">
        <nav class="breadcrumbs">
            <a href="{% url 'home' %}" style="color:#6366f1;text-decoration:none;">Home</a>
            <span>‚Ä∫</span>
            <span>Formulario</span>
        </nav>
    </div>

    {# üîî MENSAJES BACKEND (Django ya escapa HTML) #}
    {% if messages %}
        {% for message in messages %}
            <div class="alert {{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {# ‚ö° ALERTAS FRONTEND SEGURAS #}
    <div id="alertas"></div>

    <section class="box">
        <form method="POST" action="{% url 'formulario' %}">
            {% csrf_token %}

            <div class="form-group">
                <input
                    type="text"
                    name="nombre"
                    id="nombre"
                    placeholder="Nombre"
                    required
                    minlength="3"
                    maxlength="50"
                    value="{{ request.POST.nombre }}"
                >
                <small class="contador" id="nombre-contador">0 / 50</small>
            </div>

            <div class="form-group">
                <input
                    type="email"
                    name="email"
                    id="email"
                    placeholder="Email"
                    required
                    maxlength="254"
                    value="{{ request.POST.email }}"
                >
            </div>

            <div class="form-group">
                <input
                    type="text"
                    name="telefono"
                    id="telefono"
                    placeholder="Tel√©fono"
                    pattern="[0-9]{7,15}"
                    maxlength="15"
                    value="{{ request.POST.telefono }}"
                >
            </div>

            <div class="form-group">
                <input
                    type="date"
                    name="fecha_nacimiento"
                    value="{{ request.POST.fecha_nacimiento }}"
                >
            </div>

            <div class="form-group">
                <textarea
                    name="descripcion"
                    id="descripcion"
                    placeholder="Descripci√≥n"
                    maxlength="500"
                >{{ request.POST.descripcion }}</textarea>
                <small class="contador" id="descripcion-contador">0 / 500</small>
            </div>

            <div class="g-recaptcha-wrapper">
                <div class="g-recaptcha" data-sitekey="{{ site_key }}"></div>
            </div>

            <button type="submit">Guardar</button>
        </form>
    </section>

    <hr>

    <h2>Registros guardados</h2>

    {% if registros %}
        <ul>
            {% for r in registros %}
                <li>
                    <strong>{{ r.nombre }}</strong> |
                    {{ r.email }} |
                    {{ r.telefono }} |
                    {{ r.fecha_nacimiento }}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p style="text-align:center;">No hay registros a√∫n</p>
    {% endif %}
</main>

<script>
/* ================= ALERTAS SEGURAS ================= */

const alertas = document.getElementById("alertas");

function mostrarAlerta(mensaje) {
    alertas.innerHTML = "";

    const div = document.createElement("div");
    div.className = "alert error";
    div.textContent = mensaje; // üîê NO ejecuta HTML

    alertas.appendChild(div);
}

function limpiarAlerta() {
    alertas.innerHTML = "";
}

/* ================= CONTADORES ================= */

function contador(inputId, contadorId, max) {
    const input = document.getElementById(inputId);
    const contador = document.getElementById(contadorId);

    if (!input || !contador) return;

    const actualizar = () => {
        const usados = input.value.length;
        contador.textContent = `${usados} / ${max}`;
        contador.style.color = usados >= max ? "red" : "gray";
    };

    input.addEventListener("input", actualizar);
    actualizar();
}

contador("nombre", "nombre-contador", 50);
contador("descripcion", "descripcion-contador", 500);

/* ================= VALIDACIONES EN VIVO ================= */

const nombre = document.getElementById("nombre");
const email = document.getElementById("email");
const telefono = document.getElementById("telefono");

nombre.addEventListener("input", () => {
    if (nombre.value.length < 3) {
        mostrarAlerta("‚ùå El nombre debe tener al menos 3 caracteres");
    } else if (!/^[A-Za-z√Å√â√ç√ì√ö√°√©√≠√≥√∫√ë√±\s]+$/.test(nombre.value)) {
        mostrarAlerta("‚ùå El nombre solo puede contener letras");
    } else {
        limpiarAlerta();
    }
});

email.addEventListener("input", () => {
    if (!email.value.includes("@")) {
        mostrarAlerta("‚ùå Email inv√°lido");
    } else {
        limpiarAlerta();
    }
});

telefono.addEventListener("input", () => {
    if (telefono.value && !/^\d{7,15}$/.test(telefono.value)) {
        mostrarAlerta(" Tel√©fono inv√°lido (7 a 15 d√≠gitos)");
    } else {
        limpiarAlerta();
    }
});
</script>

</body>
</html>
