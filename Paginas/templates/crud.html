{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Django CRUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'styles/crud.css' %}">
    <style>
        /* Estilos de bÃºsqueda y ordenamiento */
        .search-container { 
            margin: 20px 0; 
            display: flex; 
            flex-wrap: wrap;
            gap: 10px; 
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            align-items: center;
        }
        .search-input-wrapper {
            flex: 2;
            display: flex;
            align-items: center;
            position: relative;
            min-width: 250px;
        }
        .search-input { 
            width: 100%; padding: 12px 18px 12px 40px; border: 2px solid #e2e8f0; border-radius: 10px;
            outline: none; transition: all 0.3s; font-size: 1rem;
        }
        .search-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .search-icon { position: absolute; left: 15px; color: #94a3b8; }

        .filter-select {
            flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
            background: white; outline: none; cursor: pointer; min-width: 180px;
        }
        .btn-clear {
            padding: 12px 20px; background: #f1f5f9; border: none; border-radius: 10px;
            color: #475569; cursor: pointer; transition: 0.3s; font-weight: 500;
        }
        .btn-clear:hover { background: #e2e8f0; color: #1e293b; }
        
        /* PaginaciÃ³n << < 1 2 > >> */
        .pagination { 
            display: flex; justify-content: center; align-items: center; 
            gap: 5px; margin-top: 25px; padding: 20px 0;
        }
        .page-btn {
            min-width: 38px; height: 38px; border: 1px solid #e2e8f0; background: white;
            color: #475569; cursor: pointer; border-radius: 8px; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; font-weight: 600;
        }
        .page-btn:hover:not(:disabled) { border-color: #6366f1; color: #6366f1; background: #f8fafc; }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .active-page { background: #6366f1 !important; color: white !important; border-color: #6366f1 !important; }

        #lista tr:hover { background-color: #f8fafc; }
        .date-badge { font-size: 0.85rem; color: #64748b; background: #f1f5f9; padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>

<div id="alertas"></div>

<header>
    <div class="header-content">
        <div class="header-text">
            <h1><i class="fas fa-address-book"></i> Crud</h1>
            <p>BÃºsqueda y administraciÃ³n en tiempo real</p>
        </div>
        <button class="btn btn-primary" onclick="abrirModal()">
            <i class="fas fa-plus-circle"></i> Nuevo Contacto
        </button>
    </div>
</header>

<main>
    <div class="page-container">
        <nav class="breadcrumbs">
            <a href="{% url 'home' %}" style="color:#6366f1;text-decoration:none;">Home</a>
            <span>â€º</span>
            <span>crud</span>
        </nav>

        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="busqueda" class="search-input" 
                       placeholder="Buscar por nombre, email o telÃ©fono..." 
                       onkeyup="filtrarYOrdenar()">
            </div>

            <select id="ordenarPor" class="filter-select" onchange="filtrarYOrdenar()">
                <option value="nombre_asc">ðŸ”¤ Nombre (A-Z)</option>
                <option value="nombre_desc">ðŸ”¤ Nombre (Z-A)</option>
                <option value="fecha_asc">ðŸ“… Fecha (MÃ¡s antiguos)</option>
                <option value="fecha_desc">ðŸ“… Fecha (MÃ¡s recientes)</option>
            </select>

            <button class="btn-clear" onclick="limpiarFiltros()">
                <i class="fas fa-eraser"></i> Limpiar
            </button>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>TelÃ©fono</th>
                            <th>Nacimiento</th>
                            <th style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista"></tbody>
                </table>
            </div>
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
</main>

<script>
    let registrosCache = [];      
    let registrosFiltrados = [];  
    let paginaActual = 1;
    const registrosPorPagina = 5; 

    async function cargarRegistros() {
        try {
            const res = await fetch("/api/registros/"); 
            registrosCache = await res.json();
            filtrarYOrdenar(false); 
        } catch (e) { console.error("Error cargando datos"); }
    }

    function filtrarYOrdenar(resetPagina = true) {
        const termino = document.getElementById("busqueda").value.toLowerCase().trim();
        const orden = document.getElementById("ordenarPor").value;
        
        // 1. Filtrado Global (Busca en todos los campos relevantes)
        let resultado = registrosCache.filter(r => {
            return (r.nombre || "").toLowerCase().includes(termino) ||
                   (r.email || "").toLowerCase().includes(termino) ||
                   (r.telefono || "").toLowerCase().includes(termino);
        });

        // 2. Ordenamiento
        resultado.sort((a, b) => {
            if (orden === "nombre_asc") return a.nombre.localeCompare(b.nombre);
            if (orden === "nombre_desc") return b.nombre.localeCompare(a.nombre);
            
            const dA = new Date(a.fecha_nacimiento || '1900-01-01');
            const dB = new Date(b.fecha_nacimiento || '1900-01-01');
            return orden === "fecha_asc" ? dA - dB : dB - dA;
        });

        registrosFiltrados = resultado;
        if(resetPagina) paginaActual = 1;
        renderizarTabla();
    }

    function renderizarTabla() {
        const inicio = (paginaActual - 1) * registrosPorPagina;
        const items = registrosFiltrados.slice(inicio, inicio + registrosPorPagina);
        const lista = document.getElementById("lista");

        lista.innerHTML = items.map(r => `
            <tr>
                <td><b style="color:#6366f1">${r.nombre}</b></td>
                <td>${r.email || '-'}</td>
                <td>${r.telefono || '-'}</td>
                <td><span class="date-badge">${r.fecha_nacimiento || 'N/A'}</span></td>
                <td style="text-align:center">
                    <button class="btn-icon edit" onclick="prepararEdicion(${r.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon delete" onclick="abrirModalConfirm(${r.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
        
        renderizarPaginacion();
    }

    function renderizarPaginacion() {
        const totalPaginas = Math.ceil(registrosFiltrados.length / registrosPorPagina);
        const paginationDiv = document.getElementById("pagination");
        if (totalPaginas <= 1) { paginationDiv.innerHTML = ""; return; }

        let html = `
            <button class="page-btn" title="Primero" ${paginaActual === 1 ? 'disabled' : ''} onclick="cambiarPagina(1)">Â«</button>
            <button class="page-btn" title="Anterior" ${paginaActual === 1 ? 'disabled' : ''} onclick="cambiarPagina(${paginaActual - 1})"><</button>
        `;

        for (let i = 1; i <= totalPaginas; i++) {
            if (i === 1 || i === totalPaginas || (i >= paginaActual - 1 && i <= paginaActual + 1)) {
                html += `<button class="page-btn ${i === paginaActual ? 'active-page' : ''}" onclick="cambiarPagina(${i})">${i}</button>`;
            } else if (i === paginaActual - 2 || i === paginaActual + 2) {
                html += `<span style="padding: 0 5px;">...</span>`;
            }
        }

        html += `
            <button class="page-btn" title="Siguiente" ${paginaActual === totalPaginas ? 'disabled' : ''} onclick="cambiarPagina(${paginaActual + 1})">></button>
            <button class="page-btn" title="Ãšltimo" ${paginaActual === totalPaginas ? 'disabled' : ''} onclick="cambiarPagina(${totalPaginas})">Â»</button>
        `;
        paginationDiv.innerHTML = html;
    }

    function cambiarPagina(p) { paginaActual = p; renderizarTabla(); window.scrollTo({top: 0, behavior: 'smooth'}); }

    function limpiarFiltros() {
        document.getElementById("busqueda").value = "";
        document.getElementById("ordenarPor").value = "nombre_asc";
        filtrarYOrdenar();
    }

    // Inicializar
    cargarRegistros();
</script>
</body>
</html>