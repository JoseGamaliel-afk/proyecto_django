{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Django CRUD</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'styles/crud.css' %}">
    <style>
        .search-container { margin: 20px 0; display: flex; flex-wrap: wrap; gap: 10px; background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); align-items: center; }
        .search-input-wrapper { flex: 2; display: flex; align-items: center; position: relative; min-width: 250px; }
        .search-input { width: 100%; padding: 12px 18px 12px 40px; border: 2px solid #e2e8f0; border-radius: 10px; outline: none; transition: all 0.3s; font-size: 1rem; }
        .search-input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .search-icon { position: absolute; left: 15px; color: #94a3b8; }
        .filter-select { flex: 1; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; background: white; outline: none; cursor: pointer; min-width: 180px; }
        .btn-clear { padding: 12px 20px; background: #f1f5f9; border: none; border-radius: 10px; color: #475569; cursor: pointer; transition: 0.3s; font-weight: 500; }
        .btn-clear:hover { background: #e2e8f0; color: #1e293b; }
        
        /* PaginaciÃ³n mejorada */
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 25px; padding: 20px 0; }
        .page-btn { min-width: 38px; height: 38px; border: 1px solid #e2e8f0; background: white; color: #475569; cursor: pointer; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-weight: 600; padding: 0 10px; }
        .page-btn:hover:not(:disabled) { border-color: #6366f1; color: #6366f1; background: #f8fafc; }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .active-page { background: #6366f1 !important; color: white !important; border-color: #6366f1 !important; }

        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; 
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color: #fff; margin: 5% auto; padding: 30px; 
            border-radius: 16px; width: 90%; max-width: 500px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            position: relative; animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: #334155; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; }
        
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-secondary { background: #94a3b8; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
        .btn-danger { background: #ef4444; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <div class="header-text">
            <h1><i class="fas fa-address-book"></i> CRUD API</h1>
            <p>BÃºsqueda y administraciÃ³n en tiempo real</p>
        </div>
        <button class="btn btn-primary" onclick="abrirModal()">
            <i class="fas fa-plus-circle"></i> Nuevo Contacto
        </button>
    </div>
</header>

<main>
    <div class="page-container">
        <nav class="breadcrumbs">
            <a href="/" style="color:#6366f1;text-decoration:none;">Home</a>
            <span>â€º</span>
            <span>crud</span>
        </nav>

        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="busqueda" class="search-input" placeholder="Buscar por nombre..." onkeyup="filtrarYOrdenar()">
            </div>
            <select id="ordenarPor" class="filter-select" onchange="filtrarYOrdenar()">
                <option value="nombre_asc">ðŸ”¤ Nombre (A-Z)</option>
                <option value="nombre_desc">ðŸ”¤ Nombre (Z-A)</option>
                <option value="fecha_asc">ðŸ“… Fecha (MÃ¡s antiguos)</option>
                <option value="fecha_desc">ðŸ“… Fecha (MÃ¡s recientes)</option>
            </select>
            <button class="btn-clear" onclick="limpiarFiltros()">Limpiar</button>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Email</th>
                            <th>TelÃ©fono</th>
                            <th>Nacimiento</th>
                            <th style="text-align: center;">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lista"></tbody>
                </table>
            </div>
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
</main>

<div id="modalForm" class="modal">
    <div class="modal-content">
        <h2 id="modalTitle">Nuevo Contacto</h2>
        <form id="registroForm">
            <input type="hidden" id="registroId">
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" id="nombre" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" class="form-control">
            </div>
            <div class="form-group">
                <label>TelÃ©fono</label>
                <input type="text" id="telefono" class="form-control">
            </div>
            <div class="form-group">
                <label>Fecha de Nacimiento</label>
                <input type="date" id="fecha_nacimiento" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar</button>
            </div>
        </form>
    </div>
</div>

<div id="modalConfirm" class="modal">
    <div class="modal-content">
        <h2>Â¿Eliminar registro?</h2>
        <p>Esta acciÃ³n no se puede deshacer.</p>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="cerrarModalConfirm()">Cancelar</button>
            <button class="btn-danger" id="btnConfirmarEliminar">Eliminar</button>
        </div>
    </div>
</div>

<script>
    let registrosCache = [];      
    let registrosFiltrados = [];  
    let paginaActual = 1;
    const registrosPorPagina = 5; 

    const URL_API_LISTAR = "/api/registros/";
    const URL_API_CREAR  = "/api/crear/";
    const URL_API_EDITAR = "/api/editar/"; 
    const URL_API_ELIMINAR = "/api/eliminar/";

    async function cargarRegistros() {
        try {
            const res = await fetch(URL_API_LISTAR); 
            registrosCache = await res.json();
            filtrarYOrdenar(false); 
        } catch (e) { console.error("Error cargando datos"); }
    }

    function filtrarYOrdenar(resetPagina = true) {
        const termino = document.getElementById("busqueda").value.toLowerCase().trim();
        const orden = document.getElementById("ordenarPor").value;
        let resultado = registrosCache.filter(r => {
            return (r.nombre || "").toLowerCase().includes(termino) ||
                   (r.email || "").toLowerCase().includes(termino) ||
                   (r.telefono || "").toLowerCase().includes(termino);
        });
        resultado.sort((a, b) => {
            if (orden === "nombre_asc") return a.nombre.localeCompare(b.nombre);
            if (orden === "nombre_desc") return b.nombre.localeCompare(a.nombre);
            const dA = new Date(a.fecha_nacimiento || '1900-01-01');
            const dB = new Date(b.fecha_nacimiento || '1900-01-01');
            return orden === "fecha_asc" ? dA - dB : dB - dA;
        });
        registrosFiltrados = resultado;
        if(resetPagina) paginaActual = 1;
        renderizarTabla();
    }

    function renderizarTabla() {
        const inicio = (paginaActual - 1) * registrosPorPagina;
        const items = registrosFiltrados.slice(inicio, inicio + registrosPorPagina);
        const lista = document.getElementById("lista");
        lista.innerHTML = items.map(r => `
            <tr>
                <td><b style="color:#6366f1">${r.nombre}</b></td>
                <td>${r.email || '-'}</td>
                <td>${r.telefono || '-'}</td>
                <td><span class="date-badge">${r.fecha_nacimiento || 'N/A'}</span></td>
                <td style="text-align:center">
                    <button class="btn-icon edit" onclick="prepararEdicion(${r.id})"><i class="fas fa-edit"></i></button>
                    <button class="btn-icon delete" onclick="abrirModalConfirm(${r.id})"><i class="fas fa-trash"></i></button>
                </td>
            </tr>
        `).join('');
        renderizarPaginacion();
    }

    // --- LOGICA DE PAGINACION ACTUALIZADA ---
    function renderizarPaginacion() {
        const totalPaginas = Math.ceil(registrosFiltrados.length / registrosPorPagina);
        const paginationDiv = document.getElementById("pagination");
        
        if (totalPaginas <= 1) { 
            paginationDiv.innerHTML = ""; 
            return; 
        }

        let html = "";
        
        // Ir al inicio <<
        html += `<button class="page-btn" ${paginaActual === 1 ? 'disabled' : ''} onclick="cambiarPagina(1)" title="Primera pÃ¡gina">Â«</button>`;
        
        // Anterior <
        html += `<button class="page-btn" ${paginaActual === 1 ? 'disabled' : ''} onclick="cambiarPagina(${paginaActual - 1})" title="Anterior">â€¹</button>`;

        // NÃºmeros de pÃ¡gina (Muestra la actual y un rango)
        for (let i = 1; i <= totalPaginas; i++) {
            // Solo mostrar pÃ¡ginas cercanas a la actual para no saturar si hay muchas
            if (i === 1 || i === totalPaginas || (i >= paginaActual - 1 && i <= paginaActual + 1)) {
                html += `<button class="page-btn ${i === paginaActual ? 'active-page' : ''}" onclick="cambiarPagina(${i})">${i}</button>`;
            } else if (i === paginaActual - 2 || i === paginaActual + 2) {
                html += `<span style="padding: 0 5px;">...</span>`;
            }
        }

        // Siguiente >
        html += `<button class="page-btn" ${paginaActual === totalPaginas ? 'disabled' : ''} onclick="cambiarPagina(${paginaActual + 1})" title="Siguiente">â€º</button>`;
        
        // Ir al final >>
        html += `<button class="page-btn" ${paginaActual === totalPaginas ? 'disabled' : ''} onclick="cambiarPagina(${totalPaginas})" title="Ãšltima pÃ¡gina">Â»</button>`;

        paginationDiv.innerHTML = html;
    }

    function cambiarPagina(p) { 
        if(p < 1 || p > Math.ceil(registrosFiltrados.length / registrosPorPagina)) return;
        paginaActual = p; 
        renderizarTabla(); 
    }

    // Funciones de Modal y API
    function abrirModal() {
        document.getElementById("modalTitle").innerText = "Nuevo Contacto";
        document.getElementById("registroForm").reset();
        document.getElementById("registroId").value = "";
        document.getElementById("modalForm").style.display = "block";
    }

    function cerrarModal() { document.getElementById("modalForm").style.display = "none"; }

    function prepararEdicion(id) {
        const reg = registrosCache.find(r => r.id === id);
        if(!reg) return;
        document.getElementById("modalTitle").innerText = "Editar Contacto";
        document.getElementById("registroId").value = reg.id;
        document.getElementById("nombre").value = reg.nombre;
        document.getElementById("email").value = reg.email || "";
        document.getElementById("telefono").value = reg.telefono || "";
        document.getElementById("fecha_nacimiento").value = reg.fecha_nacimiento || "";
        document.getElementById("modalForm").style.display = "block";
    }

    document.getElementById("registroForm").onsubmit = async (e) => {
        e.preventDefault();
        const id = document.getElementById("registroId").value;
        const data = {
            nombre: document.getElementById("nombre").value,
            email: document.getElementById("email").value,
            telefono: document.getElementById("telefono").value,
            fecha_nacimiento: document.getElementById("fecha_nacimiento").value,
        };

        let url = id ? `${URL_API_EDITAR}${id}/` : URL_API_CREAR;
        const method = id ? "PUT" : "POST";

        try {
            const res = await fetch(url, {
                method: method,
                headers: { "Content-Type": "application/json", "X-CSRFToken": getCookie('csrftoken') },
                body: JSON.stringify(data)
            });
            if(res.ok) { cerrarModal(); cargarRegistros(); }
        } catch (error) { console.error("Error al guardar"); }
    };

    let idAEliminar = null;
    function abrirModalConfirm(id) {
        idAEliminar = id;
        document.getElementById("modalConfirm").style.display = "block";
    }

    function cerrarModalConfirm() { document.getElementById("modalConfirm").style.display = "none"; }

    document.getElementById("btnConfirmarEliminar").onclick = async () => {
        if(!idAEliminar) return;
        try {
            const res = await fetch(`${URL_API_ELIMINAR}${idAEliminar}/`, {
                method: "DELETE",
                headers: { "X-CSRFToken": getCookie('csrftoken') }
            });
            if(res.ok) { cerrarModalConfirm(); cargarRegistros(); }
        } catch (error) { console.error("Error al eliminar"); }
    };

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function limpiarFiltros() { 
        document.getElementById("busqueda").value = ""; 
        document.getElementById("ordenarPor").value = "nombre_asc"; 
        filtrarYOrdenar(); 
    }

    cargarRegistros();
</script>
</body>
</html>